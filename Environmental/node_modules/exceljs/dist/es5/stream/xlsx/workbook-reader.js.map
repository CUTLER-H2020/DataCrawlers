{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","events","Stream","unzip","Sax","utils","FlowControl","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","Temp","WorkbookReader","module","exports","options","styles","init","properties","worksheetReaders","hyperlinkReaders","readers","atEnd","track","waitingWorkSheets","inherits","EventEmitter","_getStream","input","Readable","createReadStream","Error","flowControl","_flowControl","entries","sharedStrings","hyperlinks","worksheets","read","stream","zip","Parse","on","match","sheetNo","entry","path","autodrain","_parseWorkbook","_parseSharedStrings","_parseStyles","_parseWorksheet","createWriteStream","push","pipe","_parseHyperlinks","self","length","currentBook","processBooks","worksheetInfo","worksheet","node","cleanupSync","emit","setImmediate","err","_emitEntry","payload","type","parseStream","parser","createStream","inT","t","index","name","text","error","_getReader","Type","collection","reader","id","worksheetReader","hyperlinksReader"],"mappings":"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","file":"workbook-reader.js","sourcesContent":["/**\r\n * Copyright (c) 2015-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\nvar fs = require('fs');\r\nvar events = require('events');\r\nvar Stream = require('stream');\r\nvar unzip = require('node-unzip-2');\r\nvar Sax = require('sax');\r\n\r\nvar utils = require('../../utils/utils');\r\nvar FlowControl = require('../../utils/flow-control');\r\n\r\nvar StyleManager = require('../../xlsx/xform/style/styles-xform');\r\nvar WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\r\n\r\nvar WorksheetReader = require('./worksheet-reader');\r\nvar HyperlinkReader = require('./hyperlink-reader');\r\n\r\nvar Temp = require('temp');\r\n\r\nvar WorkbookReader = module.exports = function(options) {\r\n  this.options = options = options || {};\r\n\r\n  this.styles = new StyleManager();\r\n  this.styles.init();\r\n\r\n  this.properties = new WorkbookPropertiesManager();\r\n\r\n  // worksheet readers, indexed by sheetNo\r\n  this.worksheetReaders = {};\r\n\r\n  // hyperlink readers, indexed by sheetNo\r\n  this.hyperlinkReaders = {};\r\n\r\n  // count the open readers\r\n  this.readers = 0;\r\n\r\n  // end of stream check\r\n  this.atEnd = false;\r\n\r\n  Temp.track();\r\n  this.waitingWorkSheets = [];\r\n};\r\n\r\nutils.inherits(WorkbookReader, events.EventEmitter, {\r\n  _getStream: function(input) {\r\n    if (input instanceof Stream.Readable) {\r\n      return input;\r\n    }\r\n    if (typeof input === 'string') {\r\n      return fs.createReadStream(input);\r\n    }\r\n    throw new Error('Could not recognise input');\r\n  },\r\n\r\n  get flowControl() {\r\n    if (!this._flowControl) {\r\n      this._flowControl = new FlowControl(this.options);\r\n    }\r\n    return this._flowControl;\r\n  },\r\n\r\n  options: {\r\n    entries: ['emit'],\r\n    sharedStrings: ['cache', 'emit'],\r\n    styles: ['cache'],\r\n    hyperlinks: ['cache', 'emit'],\r\n    worksheets: ['emit']\r\n  },\r\n  read: function(input, options) {\r\n    var stream = this.stream = this._getStream(input);\r\n    var zip = this.zip = unzip.Parse();\r\n\r\n    zip.on('entry', entry => {\r\n      var match, sheetNo;\r\n      // console.log(entry.path);\r\n      switch (entry.path) {\r\n        case '_rels/.rels':\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          entry.autodrain();\r\n          break;\r\n        case 'xl/workbook.xml':\r\n          this._parseWorkbook(entry, options);\r\n          break;\r\n        case 'xl/sharedStrings.xml':\r\n          this._parseSharedStrings(entry, options);\r\n          break;\r\n        case 'xl/styles.xml':\r\n          this._parseStyles(entry, options);\r\n          break;\r\n        default:\r\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n            sheetNo = match[1];\r\n            if (this.sharedStrings) {\r\n              this._parseWorksheet(entry, sheetNo, options);\r\n            } else {\r\n              var stream = Temp.createWriteStream();\r\n              this.waitingWorkSheets.push({sheetNo: sheetNo, options: options, path: stream.path});\r\n              entry.pipe(stream);\r\n            }\r\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n            sheetNo = match[1];\r\n            this._parseHyperlinks(entry, sheetNo, options);\r\n          } else {\r\n            entry.autodrain();\r\n          }\r\n          break;\r\n      }\r\n    });\r\n\r\n    zip.on('close', () => {\r\n      var self = this;\r\n      if (this.waitingWorkSheets.length) {\r\n          var currentBook = 0;\r\n\r\n          var processBooks = function () {\r\n              var worksheetInfo = self.waitingWorkSheets[currentBook];\r\n              var entry = fs.createReadStream(worksheetInfo.path);\r\n\r\n              var sheetNo = worksheetInfo.sheetNo;\r\n              var options = worksheetInfo.options;\r\n              var worksheet = self._parseWorksheet(entry, sheetNo, options);\r\n\r\n              worksheet.on('finished', function (node) {\r\n                  ++currentBook;\r\n                  if (currentBook == self.waitingWorkSheets.length) {\r\n                      Temp.cleanupSync();\r\n                      // setImmediate(this.emit.bind(this), 'finished');\r\n\r\n                      self.emit('end');\r\n                      self.atEnd = true;\r\n                      if (!self.readers) {\r\n                          self.emit('finished');\r\n                      }\r\n                  } else {\r\n                      setImmediate(processBooks);\r\n                  }\r\n              })\r\n          }\r\n          setImmediate(processBooks);\r\n      } else {\r\n          this.emit('end');\r\n          this.atEnd = true;\r\n          if (!this.readers) {\r\n              this.emit('finished');\r\n          }\r\n      }\r\n\r\n      \r\n    });\r\n\r\n    zip.on('error', err => {\r\n      this.emit('error', err);\r\n    });\r\n\r\n    // Pipe stream into top flow-control\r\n    // this.flowControl.pipe(zip);\r\n    stream.pipe(zip);\r\n  },\r\n  _emitEntry: function(options, payload) {\r\n    if (options.entries === 'emit') {\r\n      this.emit('entry', payload);\r\n    }\r\n  },\r\n  _parseWorkbook: function(entry, options) {\r\n    this._emitEntry(options, {type: 'workbook'});\r\n    this.properties.parseStream(entry);\r\n  },\r\n  _parseSharedStrings: function(entry, options) {\r\n    this._emitEntry(options, {type: 'shared-strings'});\r\n    var self = this;\r\n    var sharedStrings = null;\r\n    switch (options.sharedStrings) {\r\n      case 'cache':\r\n        sharedStrings = this.sharedStrings = [];\r\n        break;\r\n      case 'emit':\r\n        break;\r\n      default:\r\n        entry.autodrain();\r\n        return;\r\n    }\r\n\r\n    var parser = Sax.createStream(true, {});\r\n    var inT = false;\r\n    var t = null;\r\n    var index = 0;\r\n    parser.on('opentag', function(node) {\r\n      if (node.name === 't') {\r\n        t = null;\r\n        inT = true;\r\n      }\r\n    });\r\n    parser.on('closetag', function(name) {\r\n      if (inT && (name === 't')) {\r\n        if (sharedStrings) {\r\n          sharedStrings.push(t);\r\n        } else {\r\n          self.emit('shared-string', { index: index++, text: t});\r\n        }\r\n        t = null;\r\n      }\r\n    });\r\n    parser.on('text', function(text) {\r\n      t = t ? t + text : text;\r\n    });\r\n    parser.on('error', function(error) {\r\n      self.emit('error', error);\r\n    });\r\n    entry.pipe(parser);\r\n  },\r\n  _parseStyles: function(entry, options) {\r\n    this._emitEntry(options, {type: 'styles'});\r\n    if (options.styles !== 'cache') {\r\n      entry.autodrain();\r\n      return;\r\n    }\r\n    this.styles = new StyleManager();\r\n    this.styles.parseStream(entry);\r\n  },\r\n  _getReader: function(Type, collection, sheetNo) {\r\n    var self = this;\r\n    var reader = collection[sheetNo];\r\n    if (!reader) {\r\n      reader = new Type(this, sheetNo);\r\n      self.readers++;\r\n      reader.on('finished', function() {\r\n        if (!--self.readers) {\r\n          if (self.atEnd) {\r\n            self.emit('finished');\r\n          }\r\n        }\r\n      });\r\n      collection[sheetNo] = reader;\r\n    }\r\n    return reader;\r\n  },\r\n  _parseWorksheet: function(entry, sheetNo, options) {\r\n    this._emitEntry(options, {type: 'worksheet', id: sheetNo});\r\n    var worksheetReader = this._getReader(WorksheetReader, this.worksheetReaders, sheetNo);\r\n    if (options.worksheets === 'emit') {\r\n      this.emit('worksheet', worksheetReader);\r\n    }\r\n    worksheetReader.read(entry, options, this.hyperlinkReaders[sheetNo]);\r\n    return worksheetReader;\r\n  },\r\n  _parseHyperlinks: function(entry, sheetNo, options) {\r\n    this._emitEntry(options, {type: 'hyerlinks', id: sheetNo});\r\n    var hyperlinksReader = this._getReader(HyperlinkReader, this.hyperlinkReaders, sheetNo);\r\n    if (options.hyperlinks === 'emit') {\r\n      this.emit('hyperlinks', hyperlinksReader);\r\n    }\r\n    hyperlinksReader.read(entry, options);\r\n  }\r\n});\r\n"]}